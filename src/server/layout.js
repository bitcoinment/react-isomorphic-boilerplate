import path from 'path';
const debug = require('../stdout').default('server:layout');

import favicon from '../assets/images/favicon.ico';
import touchicon from '../assets/images/icon.png';

function genJSTag(path) {
  return path ? `<script src=${path} type="text/javascript" charSet="utf-8"></script>` : '';
}

function genCSSTag(path) {
  return path ? `<link href=${path} rel="stylesheet" />` : '';
}

function genTag(path, type) {
  let method = () => {};
  if (type === 'CSS') method = genCSSTag;  
  if (type === 'JS') method = genJSTag;  
  if (!Array.isArray(path)) {
    path = [path];
  }
  const res = path.reduce((accu, p) => {
    return `${accu}\n${method(p)}`;
  }, '');
  debug(path, type, res);
  return res;
}

function getAssetInfo(asset, publicPath) {
  let js, css;
  debug(asset);
  if (Array.isArray(asset)) {
    js = [];
    css = [];
    asset.forEach((a) => {
      if (/\.js$/.test(a)) js.push(path.join(publicPath, a));
      if (/\.css/.test(a)) css.push(path.join(publicPath, a));
    });
  } else {
    js = path.join(publicPath, asset);
  }
  return {js, css};
}

function parseStats(clientStats, currentEntry) {
  const assetsByChunkName = clientStats.assetsByChunkName;
  const publicPath = clientStats.publicPath;
  debug(clientStats);
  debug(currentEntry);
  debug(assetsByChunkName);
  debug('public path', publicPath);
  const currentEntryAsset = assetsByChunkName[currentEntry] || '';
  const mainfestAsset = assetsByChunkName.manifest || '';
  const vendorAsset = assetsByChunkName.vendor || '';
  return {
    main: getAssetInfo(currentEntryAsset, publicPath),
    manifest: getAssetInfo(mainfestAsset, publicPath),
    vendor: getAssetInfo(vendorAsset, publicPath)
  };
}

function renderFullPage(content, reduxState, head, currentEntry, clientStats) {
  const { manifest: manifestAssets, main: targetAssets, vendor: vendorAssets } = parseStats(clientStats, currentEntry);
  debug('manifestAssets', manifestAssets);
  debug('targetAssets', targetAssets);
  debug('vendorAssets', vendorAssets);
  // const manifestAssets = assetsJSON.manifest || {};
  // const targetAssets = assetsJSON[currentEntry] || {};
  // const vendorAssets = assetsJSON.vendor || {}; 
  const manifestJS = genTag(manifestAssets.js, 'JS');
  const targetJS = genTag(targetAssets.js, 'JS');
  const targetCSS = genTag(targetAssets.css, 'CSS');
  const vendorJS = genTag(vendorAssets.js, 'JS');
  const vendorCSS = genTag(vendorAssets.css, 'CSS');

  return `
    <!doctype html>
    <html>
      <head>
        <meta httpEquiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta charSet="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
        ${head.title.toString()}
        ${head.meta.toString()}

        <link rel="icon" type="image/x-icon" href=${favicon} />
        <link rel="apple-touch-icon" href=${touchicon} />

        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
        ${vendorCSS}
        ${targetCSS}

        <script type="text/javascript" charSet="utf-8">
          window.__REDUX_STATE__ = ${reduxState}
        </script>
      </head>
      <body>
        <div id="app-mount-point">${content}</div>
        ${manifestJS}
        ${vendorJS}
        <!-- entry script generated by webpack -->
        ${targetJS}
      </body>
    </html>
  `;
}

export default renderFullPage;
